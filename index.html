<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¶å ´é€šçŸ¥ç”¢ç”Ÿå™¨</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .firebase-config {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .firebase-config h3 {
            margin-top: 0;
            color: #495057;
        }

        .firebase-config input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        .firebase-config button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .firebase-config button:hover {
            background: #218838;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .tab:hover {
            background: #dee2e6;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .time-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .time-btn {
            padding: 12px 20px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .time-btn.selected {
            background: #007bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
        }

        .participants {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .participant-btn {
            padding: 15px;
            border: 2px solid #6c757d;
            background: white;
            color: #6c757d;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .participant-btn.selected {
            border-color: #28a745;
            background: #28a745;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .copy-btn {
            background: #007bff;
            color: white;
        }

        .copy-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .clear-btn {
            background: #6c757d;
            color: white;
        }

        .clear-btn:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        .line-btn {
            background: #28a745;
            color: white;
        }

        .line-btn:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }

        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            min-height: 150px;
            line-height: 1.6;
        }

        .dashboard {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .leaderboard {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .leaderboard h3 {
            margin-top: 0;
            color: #495057;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            font-weight: bold;
            color: #007bff;
            margin-right: 10px;
        }

        .frequency-chart {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .frequency-chart h3 {
            margin-top: 0;
            color: #495057;
        }

        .chart-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .chart-label {
            width: 120px;
            font-size: 14px;
            color: #495057;
        }

        .chart-bar {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            margin: 0 10px;
            position: relative;
            overflow: hidden;
        }

        .chart-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .chart-value {
            width: 30px;
            text-align: right;
            font-weight: bold;
            color: #495057;
        }

        .clear-data-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .clear-data-btn:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .tab-content {
                padding: 20px;
            }

            .time-buttons {
                justify-content: center;
            }

            .participants {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .actions {
                flex-direction: column;
            }

            .action-btn {
                min-width: auto;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¸ æ¶å ´é€šçŸ¥ç”¢ç”Ÿå™¨</h1>
        </div>

        <div class="firebase-config" id="firebaseConfig">
            <h3>ğŸ”§ Firebase è¨­å®š</h3>
            <input type="text" id="apiKey" placeholder="API Key">
            <input type="text" id="authDomain" placeholder="Auth Domain (ä¾‹å¦‚: your-project.firebaseapp.com)">
            <input type="text" id="databaseURL" placeholder="Database URL (ä¾‹å¦‚: https://your-project-default-rtdb.asia-southeast1.firebasedatabase.app/)">
            <input type="text" id="projectId" placeholder="Project ID">
            <button onclick="connectFirebase()">é€£æ¥ Firebase</button>
            <div id="statusMessage" class="status-message"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('generator')">é€šçŸ¥ç”¢ç”Ÿå™¨</button>
            <button class="tab" onclick="showTab('dashboard')">æ‰“çƒé »ç‡å„€è¡¨æ¿</button>
        </div>

        <div id="generator" class="tab-content active">
            <h2>â° é¸æ“‡æ™‚é–“</h2>
            <div class="time-buttons">
                <button class="time-btn" onclick="selectTime('18:00')">18:00</button>
                <button class="time-btn" onclick="selectTime('18:30')">18:30</button>
                <button class="time-btn" onclick="selectTime('19:00')">19:00</button>
                <button class="time-btn" onclick="selectTime('19:30')">19:30</button>
                <button class="time-btn" onclick="selectTime('20:00')">20:00</button>
            </div>

            <h2>ğŸ‘¥ é¸æ“‡åƒèˆ‡è€…</h2>
            <div class="participants">
                <button class="participant-btn" onclick="toggleParticipant('ä½³ä½‘ Arvin')">ä½³ä½‘ Arvin</button>
                <button class="participant-btn" onclick="toggleParticipant('éŸ‹ä¼¶ Lynn')">éŸ‹ä¼¶ Lynn</button>
                <button class="participant-btn" onclick="toggleParticipant('å®¶æ¦® Barry')">å®¶æ¦® Barry</button>
                <button class="participant-btn" onclick="toggleParticipant('æ¯…åº­ Eden')">æ¯…åº­ Eden</button>
                <button class="participant-btn" onclick="toggleParticipant('å† å‹³ Andersen')">å† å‹³ Andersen</button>
                <button class="participant-btn" onclick="toggleParticipant('åœ‹å® Luke')">åœ‹å® Luke</button>
                <button class="participant-btn" onclick="toggleParticipant('åº­å®‡ Ben')">åº­å®‡ Ben</button>
                <button class="participant-btn" onclick="toggleParticipant('é¡¯å¾· Jerry')">é¡¯å¾· Jerry</button>
                <button class="participant-btn" onclick="toggleParticipant('å˜‰è ChiaWen')">å˜‰è ChiaWen</button>
                <button class="participant-btn" onclick="toggleParticipant('å¯Œç¿” Oscar')">å¯Œç¿” Oscar</button>
                <button class="participant-btn" onclick="toggleParticipant('å† ç¿” Damien')">å† ç¿” Damien</button>
                <button class="participant-btn" onclick="toggleParticipant('æ–¹ç…’ Tony')">æ–¹ç…’ Tony</button>
                <button class="participant-btn" onclick="toggleParticipant('æ°å‡± Adam')">æ°å‡± Adam</button>
                <button class="participant-btn" onclick="toggleParticipant('æ”¿å®‡ Dennis')">æ”¿å®‡ Dennis</button>
                <button class="participant-btn" onclick="toggleParticipant('å®‡æº¢ Eugene')">å®‡æº¢ Eugene</button>
                <button class="participant-btn" onclick="toggleParticipant('éˆè²¿ CM')">éˆè²¿ CM</button>
                <button class="participant-btn" onclick="toggleParticipant('å°ç™½ Chuck')">å°ç™½ Chuck</button>
                <button class="participant-btn" onclick="toggleParticipant('æ¥Šå‡± Zack')">æ¥Šå‡± Zack</button>
                <button class="participant-btn" onclick="toggleParticipant('ä½³å® Ian')">ä½³å® Ian</button>
                <button class="participant-btn" onclick="toggleParticipant('å¾·æ…¶ Lantis')">å¾·æ…¶ Lantis</button>
                <button class="participant-btn" onclick="toggleParticipant('å˜‰èƒ¤ John')">å˜‰èƒ¤ John</button>
                <button class="participant-btn" onclick="toggleParticipant('å®—ç¿°')">å®—ç¿°</button>
            </div>

            <div class="actions">
                <button class="action-btn copy-btn" onclick="copyText()">ğŸ“‹ è¤‡è£½æ–‡å­—</button>
                <button class="action-btn clear-btn" onclick="clearAll()">ğŸ§¹ æ¸…ç©ºå…¨éƒ¨</button>
                <button class="action-btn line-btn" onclick="shareToLine()">ğŸ’¬ åˆ†äº«åˆ° LINE</button>
            </div>

            <div class="output" id="output">è«‹é¸æ“‡æ™‚é–“å’Œåƒèˆ‡è€…...</div>
        </div>

        <div id="dashboard" class="tab-content">
            <div class="dashboard">
                <h2>ğŸ“Š æ‰“çƒé »ç‡çµ±è¨ˆ</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalNotifications">0</div>
                        <div class="stat-label">ç¸½é€šçŸ¥æ¬¡æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeParticipants">0</div>
                        <div class="stat-label">æ´»èºåƒèˆ‡è€…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lastUpdate">å¾æœª</div>
                        <div class="stat-label">æœ€å¾Œæ›´æ–°</div>
                    </div>
                </div>

                <div class="leaderboard">
                    <h3>ğŸ† åƒèˆ‡æ’è¡Œæ¦œ (å‰5å)</h3>
                    <div id="leaderboardList">
                        <div class="leaderboard-item">
                            <span>æš«ç„¡æ•¸æ“š</span>
                        </div>
                    </div>
                </div>

                <div class="frequency-chart">
                    <h3>ğŸ“ˆ å€‹äººæ‰“çƒé »ç‡</h3>
                    <div id="frequencyChart">
                        <div class="chart-item">
                            <span>æš«ç„¡æ•¸æ“š</span>
                        </div>
                    </div>
                </div>

                <button class="clear-data-btn" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰çµ±è¨ˆè³‡æ–™</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        let selectedTime = '';
        let selectedParticipants = [];
        let isFirebaseConnected = false;
        let database = null;

        const participants = [
            'ä½³ä½‘ Arvin', 'éŸ‹ä¼¶ Lynn', 'å®¶æ¦® Barry', 'æ¯…åº­ Eden', 'å† å‹³ Andersen',
            'åœ‹å® Luke', 'åº­å®‡ Ben', 'é¡¯å¾· Jerry', 'å˜‰è ChiaWen', 'å¯Œç¿” Oscar',
            'å† ç¿” Damien', 'æ–¹ç…’ Tony', 'æ°å‡± Adam', 'æ”¿å®‡ Dennis', 'å®‡æº¢ Eugene',
            'éˆè²¿ CM', 'å°ç™½ Chuck', 'æ¥Šå‡± Zack', 'ä½³å® Ian', 'å¾·æ…¶ Lantis',
            'å˜‰èƒ¤ John', 'å®—ç¿°'
        ];

        function connectFirebase() {
            const apiKey = document.getElementById('apiKey').value;
            const authDomain = document.getElementById('authDomain').value;
            const databaseURL = document.getElementById('databaseURL').value;
            const projectId = document.getElementById('projectId').value;

            if (!apiKey || !authDomain || !databaseURL || !projectId) {
                showStatus('è«‹å¡«å¯«æ‰€æœ‰ Firebase è¨­å®šæ¬„ä½', 'error');
                return;
            }

            try {
                const firebaseConfig = {
                    apiKey: apiKey,
                    authDomain: authDomain,
                    databaseURL: databaseURL,
                    projectId: projectId
                };

                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseConnected = true;

                // å„²å­˜è¨­å®šåˆ° localStorage
                localStorage.setItem('firebaseConfig', JSON.stringify(firebaseConfig));

                showStatus('Firebase é€£æ¥æˆåŠŸï¼é›²ç«¯åŒæ­¥å·²å•Ÿç”¨ã€‚', 'success');
                
                // éš±è—è¨­å®šå€åŸŸ
                setTimeout(() => {
                    document.getElementById('firebaseConfig').style.display = 'none';
                }, 2000);

                // è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š
                loadDashboardData();
            } catch (error) {
                console.error('Firebase é€£æ¥å¤±æ•—:', error);
                showStatus('Firebase é€£æ¥å¤±æ•—ï¼š' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„ Firebase è¨­å®š
        function checkSavedConfig() {
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('apiKey').value = config.apiKey || '';
                    document.getElementById('authDomain').value = config.authDomain || '';
                    document.getElementById('databaseURL').value = config.databaseURL || '';
                    document.getElementById('projectId').value = config.projectId || '';
                    
                    // è‡ªå‹•é€£æ¥
                    connectFirebase();
                } catch (error) {
                    console.error('è¼‰å…¥å„²å­˜çš„è¨­å®šå¤±æ•—:', error);
                }
            }
        }

        function showTab(tabName) {
            // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            // ç§»é™¤æ‰€æœ‰åˆ†é æŒ‰éˆ•çš„ active é¡åˆ¥
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // é¡¯ç¤ºé¸ä¸­çš„åˆ†é å…§å®¹
            document.getElementById(tabName).classList.add('active');

            // æ·»åŠ  active é¡åˆ¥åˆ°å°æ‡‰çš„åˆ†é æŒ‰éˆ•
            event.target.classList.add('active');

            // å¦‚æœåˆ‡æ›åˆ°å„€è¡¨æ¿ï¼Œè¼‰å…¥æ•¸æ“š
            if (tabName === 'dashboard') {
                loadDashboardData();
            }
        }

        function selectTime(time) {
            selectedTime = time;
            
            // ç§»é™¤æ‰€æœ‰æ™‚é–“æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
            const timeButtons = document.querySelectorAll('.time-btn');
            timeButtons.forEach(btn => btn.classList.remove('selected'));
            
            // æ·»åŠ é¸ä¸­ç‹€æ…‹åˆ°ç•¶å‰æŒ‰éˆ•
            event.target.classList.add('selected');
            
            updateParticipantButtons();
            updateOutput();
        }

        function toggleParticipant(name) {
            if (!selectedTime) {
                alert('è«‹å…ˆé¸æ“‡æ™‚é–“ï¼');
                return;
            }

            const index = selectedParticipants.findIndex(p => p.name === name);
            
            if (index > -1) {
                // ç§»é™¤åƒèˆ‡è€…
                selectedParticipants.splice(index, 1);
                event.target.classList.remove('selected');
                event.target.textContent = name;
            } else {
                // æ·»åŠ åƒèˆ‡è€…
                selectedParticipants.push({ name: name, time: selectedTime });
                event.target.classList.add('selected');
                event.target.textContent = `${name} âœ… (${selectedTime})`;
            }
            
            updateOutput();
        }

        function updateParticipantButtons() {
            const participantButtons = document.querySelectorAll('.participant-btn');
            participantButtons.forEach(btn => {
                const name = btn.textContent.replace(' âœ… (18:00)', '').replace(' âœ… (18:30)', '').replace(' âœ… (19:00)', '').replace(' âœ… (19:30)', '').replace(' âœ… (20:00)', '');
                const participant = selectedParticipants.find(p => p.name === name);
                
                if (participant) {
                    btn.classList.add('selected');
                    btn.textContent = `${name} âœ… (${participant.time})`;
                } else {
                    btn.classList.remove('selected');
                    btn.textContent = name;
                }
            });
        }

        function updateOutput() {
            const output = document.getElementById('output');
            
            if (selectedParticipants.length === 0) {
                output.textContent = 'è«‹é¸æ“‡æ™‚é–“å’Œåƒèˆ‡è€…...';
                return;
            }

            // æŒ‰æ™‚é–“åˆ†çµ„
            const timeGroups = {};
            selectedParticipants.forEach(participant => {
                if (!timeGroups[participant.time]) {
                    timeGroups[participant.time] = [];
                }
                timeGroups[participant.time].push(participant.name);
            });

            // ç”Ÿæˆè¼¸å‡ºæ–‡å­—
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
            
            let outputText = `éº»ç…©${dateStr}æ™šä¸Šä»£è¨‚å ´åœ°\n03-560-1068\nå ´åœ°é ç´„é †åºABCD\n`;
            
            Object.keys(timeGroups).sort().forEach(time => {
                const names = timeGroups[time];
                outputText += `${time}\n`;
                outputText += `CK17583${names.map(name => name.split(' ')[0]).join('')}\n`;
            });

            output.textContent = outputText;
        }

        function copyText() {
            const output = document.getElementById('output');
            const text = output.textContent;
            
            if (text === 'è«‹é¸æ“‡æ™‚é–“å’Œåƒèˆ‡è€…...') {
                alert('è«‹å…ˆé¸æ“‡æ™‚é–“å’Œåƒèˆ‡è€…ï¼');
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                // é¸ä¸­æ–‡å­—ä»¥æä¾›è¦–è¦ºåé¥‹
                const range = document.createRange();
                range.selectNodeContents(output);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                // è¨˜éŒ„æ•¸æ“š
                recordData();
            }).catch(err => {
                console.error('è¤‡è£½å¤±æ•—:', err);
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½æ–‡å­—');
            });
        }

        function shareToLine() {
            const output = document.getElementById('output');
            const text = output.textContent;
            
            if (text === 'è«‹é¸æ“‡æ™‚é–“å’Œåƒèˆ‡è€…...') {
                alert('è«‹å…ˆé¸æ“‡æ™‚é–“å’Œåƒèˆ‡è€…ï¼');
                return;
            }

            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
            window.open(lineUrl, '_blank');

            // è¨˜éŒ„æ•¸æ“š
            recordData();
        }

        function clearAll() {
            selectedTime = '';
            selectedParticipants = [];
            
            // æ¸…é™¤æ‰€æœ‰æŒ‰éˆ•çš„é¸ä¸­ç‹€æ…‹
            const timeButtons = document.querySelectorAll('.time-btn');
            timeButtons.forEach(btn => btn.classList.remove('selected'));
            
            const participantButtons = document.querySelectorAll('.participant-btn');
            participantButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                btn.textContent = participants[index];
            });
            
            updateOutput();
        }

        function recordData() {
            if (selectedParticipants.length === 0) return;

            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD æ ¼å¼
            const timestamp = new Date().toISOString();

            const recordData = {
                date: today,
                participants: selectedParticipants.map(p => p.name),
                timestamp: timestamp
            };

            if (isFirebaseConnected && database) {
                // å„²å­˜åˆ° Firebase
                saveToFirebase(recordData);
            } else {
                // å„²å­˜åˆ° localStorage ä½œç‚ºå‚™ç”¨
                saveToLocalStorage(recordData);
            }
        }

        function saveToFirebase(recordData) {
            try {
                // å„²å­˜ç•¶æ—¥è¨˜éŒ„ï¼ˆæœƒè¦†è“‹åŒä¸€å¤©çš„èˆŠè¨˜éŒ„ï¼‰
                database.ref(`court_reminders/${recordData.date}`).set(recordData);

                // æ›´æ–°å€‹äººçµ±è¨ˆ
                recordData.participants.forEach(participant => {
                    const participantRef = database.ref(`statistics/${participant.replace(/\s+/g, '_')}`);
                    participantRef.transaction((currentData) => {
                        if (currentData === null) {
                            return {
                                name: participant,
                                count: 1
                            };
                        } else {
                            return {
                                name: participant,
                                count: currentData.count + 1
                            };
                        }
                    });
                });

                console.log('æ•¸æ“šå·²å„²å­˜åˆ° Firebase');
            } catch (error) {
                console.error('Firebase å„²å­˜å¤±æ•—:', error);
                // å¦‚æœ Firebase å¤±æ•—ï¼Œä½¿ç”¨ localStorage å‚™ç”¨
                saveToLocalStorage(recordData);
            }
        }

        function saveToLocalStorage(recordData) {
            try {
                // ç²å–ç¾æœ‰æ•¸æ“š
                const existingData = JSON.parse(localStorage.getItem('courtReminderData') || '{}');
                
                // å„²å­˜ç•¶æ—¥è¨˜éŒ„
                existingData[recordData.date] = recordData;
                
                // æ›´æ–°å€‹äººçµ±è¨ˆ
                const statistics = JSON.parse(localStorage.getItem('courtReminderStats') || '{}');
                recordData.participants.forEach(participant => {
                    if (!statistics[participant]) {
                        statistics[participant] = { name: participant, count: 0 };
                    }
                    statistics[participant].count++;
                });
                
                localStorage.setItem('courtReminderData', JSON.stringify(existingData));
                localStorage.setItem('courtReminderStats', JSON.stringify(statistics));
                
                console.log('æ•¸æ“šå·²å„²å­˜åˆ°æœ¬åœ°å„²å­˜');
            } catch (error) {
                console.error('æœ¬åœ°å„²å­˜å¤±æ•—:', error);
            }
        }

        function loadDashboardData() {
            if (isFirebaseConnected && database) {
                loadFromFirebase();
            } else {
                loadFromLocalStorage();
            }
        }

        function loadFromFirebase() {
            try {
                // è¼‰å…¥çµ±è¨ˆæ•¸æ“š
                database.ref('statistics').once('value', (snapshot) => {
                    const statistics = snapshot.val() || {};
                    updateDashboard(statistics);
                });

                // è¼‰å…¥è¨˜éŒ„æ•¸æ“šä»¥è¨ˆç®—ç¸½é€šçŸ¥æ¬¡æ•¸å’Œæœ€å¾Œæ›´æ–°æ™‚é–“
                database.ref('court_reminders').once('value', (snapshot) => {
                    const records = snapshot.val() || {};
                    updateGeneralStats(records);
                });
            } catch (error) {
                console.error('Firebase è¼‰å…¥å¤±æ•—:', error);
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            try {
                const statistics = JSON.parse(localStorage.getItem('courtReminderStats') || '{}');
                const records = JSON.parse(localStorage.getItem('courtReminderData') || '{}');
                
                updateDashboard(statistics);
                updateGeneralStats(records);
            } catch (error) {
                console.error('æœ¬åœ°å„²å­˜è¼‰å…¥å¤±æ•—:', error);
            }
        }

        function updateDashboard(statistics) {
            // è½‰æ›ç‚ºé™£åˆ—ä¸¦æ’åº
            const statsArray = Object.values(statistics).sort((a, b) => b.count - a.count);
            
            // æ›´æ–°æ´»èºåƒèˆ‡è€…æ•¸é‡
            document.getElementById('activeParticipants').textContent = statsArray.length;
            
            // æ›´æ–°æ’è¡Œæ¦œ
            updateLeaderboard(statsArray);
            
            // æ›´æ–°é »ç‡åœ–è¡¨
            updateFrequencyChart(statsArray);
        }

        function updateGeneralStats(records) {
            const recordsArray = Object.values(records);
            
            // æ›´æ–°ç¸½é€šçŸ¥æ¬¡æ•¸
            document.getElementById('totalNotifications').textContent = recordsArray.length;
            
            // æ›´æ–°æœ€å¾Œæ›´æ–°æ™‚é–“
            if (recordsArray.length > 0) {
                const lastRecord = recordsArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                const lastUpdate = new Date(lastRecord.timestamp);
                const timeStr = lastUpdate.toLocaleString('zh-TW');
                document.getElementById('lastUpdate').textContent = timeStr;
            }
        }

        function updateLeaderboard(statsArray) {
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (statsArray.length === 0) {
                leaderboardList.innerHTML = '<div class="leaderboard-item"><span>æš«ç„¡æ•¸æ“š</span></div>';
                return;
            }
            
            const top5 = statsArray.slice(0, 5);
            leaderboardList.innerHTML = top5.map((stat, index) => `
                <div class="leaderboard-item">
                    <span><span class="rank">#${index + 1}</span>${stat.name}</span>
                    <span>${stat.count} æ¬¡</span>
                </div>
            `).join('');
        }

        function updateFrequencyChart(statsArray) {
            const frequencyChart = document.getElementById('frequencyChart');
            
            if (statsArray.length === 0) {
                frequencyChart.innerHTML = '<div class="chart-item"><span>æš«ç„¡æ•¸æ“š</span></div>';
                return;
            }
            
            const maxCount = Math.max(...statsArray.map(s => s.count));
            
            // é¡¯ç¤ºæ‰€æœ‰åƒèˆ‡è€…ï¼ŒåŒ…æ‹¬æ¬¡æ•¸ç‚º 0 çš„
            const allParticipants = participants.map(name => {
                const stat = statsArray.find(s => s.name === name);
                return {
                    name: name,
                    count: stat ? stat.count : 0
                };
            });
            
            frequencyChart.innerHTML = allParticipants.map(stat => {
                const percentage = maxCount > 0 ? (stat.count / maxCount) * 100 : 0;
                return `
                    <div class="chart-item">
                        <div class="chart-label">${stat.name}</div>
                        <div class="chart-bar">
                            <div class="chart-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="chart-value">${stat.count}</div>
                    </div>
                `;
            }).join('');
        }

        function clearAllData() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰çµ±è¨ˆè³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                if (isFirebaseConnected && database) {
                    // æ¸…é™¤ Firebase æ•¸æ“š
                    database.ref('statistics').remove();
                    database.ref('court_reminders').remove();
                }
                
                // æ¸…é™¤æœ¬åœ°å„²å­˜
                localStorage.removeItem('courtReminderData');
                localStorage.removeItem('courtReminderStats');
                
                // é‡æ–°è¼‰å…¥å„€è¡¨æ¿
                loadDashboardData();
                
                alert('æ‰€æœ‰çµ±è¨ˆè³‡æ–™å·²æ¸…é™¤');
            }
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥å„²å­˜çš„è¨­å®š
        window.addEventListener('load', () => {
            checkSavedConfig();
        });
    </script>
</body>
</html>

