<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¸ æ¶å ´é€šçŸ¥ç”¢ç”Ÿå™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            text-align: center;
            padding: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #4facfe;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .time-buttons, .participant-buttons {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-buttons {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        }

        .participant-buttons {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .btn {
            padding: 12px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .btn.selected {
            background: #4facfe;
            color: white;
            border-color: #4facfe;
        }

        .output-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .output-text {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            min-height: 100px;
            font-family: monospace;
            white-space: pre-wrap;
            margin-bottom: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .copy-btn {
            background: #28a745;
            color: white;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .line-btn {
            background: #00c851;
            color: white;
        }

        .line-btn:hover {
            background: #00a844;
        }

        .clear-btn {
            background: #dc3545;
            color: white;
        }

        .clear-btn:hover {
            background: #c82333;
        }

        .status-message {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* å„€è¡¨æ¿æ¨£å¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .ranking-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .ranking-number {
            font-weight: bold;
            color: #4facfe;
            margin-right: 10px;
        }

        .frequency-chart {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }

        .chart-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .chart-label {
            width: 120px;
            font-size: 14px;
        }

        .chart-bar {
            height: 20px;
            background: #4facfe;
            border-radius: 10px;
            margin: 0 10px;
            transition: width 0.5s ease;
        }

        .chart-value {
            font-weight: bold;
            color: #333;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }

            .header h1 {
                font-size: 2em;
            }

            .participant-buttons {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¸ æ¶å ´é€šçŸ¥ç”¢ç”Ÿå™¨</h1>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('generator')">é€šçŸ¥ç”¢ç”Ÿå™¨</button>
            <button class="tab" onclick="switchTab('dashboard')">æ‰“çƒé »ç‡å„€è¡¨æ¿</button>
        </div>

        <!-- é€šçŸ¥ç”¢ç”Ÿå™¨åˆ†é  -->
        <div id="generator" class="tab-content active">
            <div class="section">
                <h2>â° é¸æ“‡æ™‚é–“</h2>
                <div class="time-buttons">
                    <button class="btn" onclick="selectTime('18:00')">18:00</button>
                    <button class="btn" onclick="selectTime('18:30')">18:30</button>
                    <button class="btn" onclick="selectTime('19:00')">19:00</button>
                    <button class="btn" onclick="selectTime('19:30')">19:30</button>
                    <button class="btn" onclick="selectTime('20:00')">20:00</button>
                </div>
            </div>

            <div class="section">
                <h2>ğŸ‘¥ é¸æ“‡åƒèˆ‡è€…</h2>
                <div class="participant-buttons">
                    <button class="btn" onclick="toggleParticipant('ä½³ä½‘ Arvin')">ä½³ä½‘ Arvin</button>
                    <button class="btn" onclick="toggleParticipant('éŸ‹ä¼¶ Lynn')">éŸ‹ä¼¶ Lynn</button>
                    <button class="btn" onclick="toggleParticipant('å®¶æ¦® Barry')">å®¶æ¦® Barry</button>
                    <button class="btn" onclick="toggleParticipant('æ¯…åº­ Eden')">æ¯…åº­ Eden</button>
                    <button class="btn" onclick="toggleParticipant('å† å‹³ Andersen')">å† å‹³ Andersen</button>
                    <button class="btn" onclick="toggleParticipant('åœ‹å® Luke')">åœ‹å® Luke</button>
                    <button class="btn" onclick="toggleParticipant('åº­å®‡ Ben')">åº­å®‡ Ben</button>
                    <button class="btn" onclick="toggleParticipant('é¡¯å¾· Jerry')">é¡¯å¾· Jerry</button>
                    <button class="btn" onclick="toggleParticipant('å˜‰è ChiaWen')">å˜‰è ChiaWen</button>
                    <button class="btn" onclick="toggleParticipant('å¯Œç¿” Oscar')">å¯Œç¿” Oscar</button>
                    <button class="btn" onclick="toggleParticipant('å† ç¿” Damien')">å† ç¿” Damien</button>
                    <button class="btn" onclick="toggleParticipant('æ–¹ç…’ Tony')">æ–¹ç…’ Tony</button>
                    <button class="btn" onclick="toggleParticipant('æ°å‡± Adam')">æ°å‡± Adam</button>
                    <button class="btn" onclick="toggleParticipant('æ”¿å®‡ Dennis')">æ”¿å®‡ Dennis</button>
                    <button class="btn" onclick="toggleParticipant('å®‡æº¢ Eugene')">å®‡æº¢ Eugene</button>
                    <button class="btn" onclick="toggleParticipant('éˆè²¿ CM')">éˆè²¿ CM</button>
                    <button class="btn" onclick="toggleParticipant('å°ç™½ Chuck')">å°ç™½ Chuck</button>
                    <button class="btn" onclick="toggleParticipant('æ¥Šå‡± Zack')">æ¥Šå‡± Zack</button>
                    <button class="btn" onclick="toggleParticipant('ä½³å® Ian')">ä½³å® Ian</button>
                    <button class="btn" onclick="toggleParticipant('å¾·æ…¶ Lantis')">å¾·æ…¶ Lantis</button>
                    <button class="btn" onclick="toggleParticipant('å˜‰èƒ¤ John')">å˜‰èƒ¤ John</button>
                    <button class="btn" onclick="toggleParticipant('å®—ç¿°')">å®—ç¿°</button>
                </div>
            </div>

            <div class="output-section">
                <h3>ğŸ“ ç”Ÿæˆçš„è¨Šæ¯</h3>
                <div id="outputText" class="output-text">è«‹é¸æ“‡æ™‚é–“å’Œåƒèˆ‡è€…ä¾†ç”Ÿæˆè¨Šæ¯</div>
                <div class="action-buttons">
                    <button class="action-btn copy-btn" onclick="copyText()">è¤‡è£½æ–‡å­—</button>
                    <a id="lineShareBtn" class="action-btn line-btn" href="#" target="_blank">åˆ†äº«åˆ° LINE</a>
                    <button class="action-btn clear-btn" onclick="clearAll()">æ¸…ç©º</button>
                </div>
                <div id="statusMessage" class="status-message" style="display: none;"></div>
            </div>
        </div>

        <!-- å„€è¡¨æ¿åˆ†é  -->
        <div id="dashboard" class="tab-content">
            <div class="section">
                <h2>ğŸ“Š æ‰“çƒé »ç‡çµ±è¨ˆ</h2>
                <div id="statsGrid" class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalNotifications">-</div>
                        <div class="stat-label">ç¸½é€šçŸ¥æ¬¡æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeParticipants">-</div>
                        <div class="stat-label">æ´»èºåƒèˆ‡è€…</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lastUpdate">-</div>
                        <div class="stat-label">æœ€å¾Œæ›´æ–°</div>
                    </div>
                </div>

                <div class="ranking-section">
                    <h3>ğŸ† åƒèˆ‡æ’è¡Œæ¦œ (å‰5å)</h3>
                    <div id="rankingList">è¼‰å…¥ä¸­...</div>
                </div>

                <div class="frequency-chart">
                    <h3>ğŸ“ˆ å€‹äººæ‰“çƒé »ç‡</h3>
                    <div id="frequencyChart">è¼‰å…¥ä¸­...</div>
                </div>

                <button class="action-btn clear-btn" onclick="clearAllData()">æ¸…é™¤æ‰€æœ‰çµ±è¨ˆè³‡æ–™</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase è¨­å®š - ç›´æ¥å¯«å…¥ç¨‹å¼ç¢¼
        const firebaseConfig = {
            apiKey: "AIzaSyDGFHc0KRKUeWe8N0GIDB6dyju2",
            authDomain: "court-reminder-app.firebaseapp.com",
            databaseURL: "https://court-reminder-app-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "court-reminder-app",
            storageBucket: "court-reminder-app.firebasestorage.app",
            messagingSenderId: "102732055590",
            appId: "1:102732055590:web:728859a327b5b8"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // å…¨åŸŸè®Šæ•¸
        let selectedTime = '';
        let selectedParticipants = [];
        let isFirebaseConnected = true;

        // åˆ†é åˆ‡æ›
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰åˆ†é çš„ active é¡åˆ¥
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // é¡¯ç¤ºé¸ä¸­çš„åˆ†é 
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // å¦‚æœåˆ‡æ›åˆ°å„€è¡¨æ¿ï¼Œè¼‰å…¥çµ±è¨ˆæ•¸æ“š
            if (tabName === 'dashboard') {
                loadDashboardData();
            }
        }

        // é¸æ“‡æ™‚é–“
        function selectTime(time) {
            selectedTime = time;
            
            // æ›´æ–°æŒ‰éˆ•æ¨£å¼
            document.querySelectorAll('.time-buttons .btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // æ¸…ç©ºå·²é¸æ“‡çš„åƒèˆ‡è€…
            selectedParticipants = [];
            updateParticipantButtons();
            generateMessage();
        }

        // åˆ‡æ›åƒèˆ‡è€…
        // âœ… æ›´æ–° toggleParticipantï¼ˆåŒå€‹äººé¸æ“‡æ–°æ™‚æ®µæœƒæ›´æ–°æ™‚é–“ï¼‰
function toggleParticipant(name) {
    if (!selectedTime) {
        showStatus('è«‹å…ˆé¸æ“‡æ™‚é–“', 'error');
        return;
    }

    const existingIndex = selectedParticipants.findIndex(p => p.name === name);

    if (existingIndex > -1) {
        if (selectedParticipants[existingIndex].time === selectedTime) {
            selectedParticipants.splice(existingIndex, 1); // å–æ¶ˆé¸æ“‡
        } else {
            selectedParticipants[existingIndex].time = selectedTime; // æ›´æ–°æ™‚é–“
        }
    } else {
        selectedParticipants.push({ name, time: selectedTime });
    }

    updateParticipantButtons();
    generateMessage();
}

        // âœ… æ›´æ–° participant button é¡¯ç¤º
function updateParticipantButtons() {
    document.querySelectorAll('.participant-buttons .btn').forEach(btn => {
        const name = btn.textContent.split(' âœ…')[0];
        const participant = selectedParticipants.find(p => p.name === name);

        if (participant) {
            btn.textContent = `${name} âœ… (${participant.time})`;
            btn.classList.add('selected');
        } else {
            btn.textContent = name;
            btn.classList.remove('selected');
        }
    });
}

        // âœ… ä¿®æ”¹è¨Šæ¯æ ¼å¼ï¼ˆç…§ä½ æŒ‡å®šçš„æ–‡å­—æ’ç‰ˆï¼‰
function generateMessage() {
    if (selectedParticipants.length === 0) {
        document.getElementById('outputText').textContent = 'è«‹é¸æ“‡æ™‚é–“å’Œåƒèˆ‡è€…ä¾†ç”Ÿæˆè¨Šæ¯';
        document.getElementById('lineShareBtn').href = '#';
        return;
    }

    const idMap = {
        'ä½³ä½‘ Arvin': 'CK17583è”¡ä½³ä½‘483',
        'éŸ‹ä¼¶ Lynn': 'CK17671è³´éŸ‹ä¼¶ 052',
        'å®¶æ¦® Barry': 'CK17653ç‹å®¶æ¦®421',
        'æ¯…åº­ Eden': 'CK17733ç°¡æ¯…åº­374',
        'å† å‹³ Andersen': 'CK17759é™³å† å‹³033',
        'åœ‹å® Luke': 'CK17778åŒ…åœ‹å®063',
        'åº­å®‡ Ben': 'CK17801åŠ‰åº­å®‡161',
        'é¡¯å¾· Jerry': 'CK17688ç‹é¡¯å¾·299',
        'å˜‰è ChiaWen': 'CK17792å¼µå˜‰è531',
        'å¯Œç¿” Oscar': 'CK17764æå¯Œç¿”947',
        'å† ç¿” Damien': 'CK17699è‘‰å† ç¿”885',
        'æ–¹ç…’ Tony': 'CK17832å³æ–¹ç…’671',
        'æ°å‡± Adam': 'CK17688æ—æ°å‡±092',
        'æ”¿å®‡ Dennis': 'CK17589ææ”¿å®‡644',
        'å®‡æº¢ Eugene': 'CK17813è¨±å®‡æº¢772',
        'éˆè²¿ CM': 'CK17644é„§éˆè²¿158',
        'å°ç™½ Chuck': 'CK17773é„­å°ç™½159',
        'æ¥Šå‡± Zack': 'CK17594æ¥Šå‡±ç«‹305',
        'ä½³å® Ian': 'CK17827å»–ä½³å®810',
        'å¾·æ…¶ Lantis': 'CK17655æ—å¾·æ…¶227',
        'å˜‰èƒ¤ John': 'CK17808æå˜‰èƒ¤583',
        'å®—ç¿°': 'CK17877é»ƒå®—ç¿°948'
    };

    const timeGroups = {};
    selectedParticipants.forEach(p => {
        const id = idMap[p.name] || p.name;
        if (!timeGroups[p.time]) timeGroups[p.time] = [];
        timeGroups[p.time].push(id);
    });

    let message = `éº»ç…©14:00å¹«å¿™ä¸€èµ·æ¶å ´åœ°\n03-560-1068\nå ´åœ°é ç´„é †åºABCD\n`;

    Object.keys(timeGroups).sort().forEach(time => {
        message += `\n${time}\n`;
        timeGroups[time].forEach(name => {
            message += `${name}\n`;
        });
    });

    document.getElementById('outputText').textContent = message.trim();
    document.getElementById('lineShareBtn').href = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
}
            // æ›´æ–° LINE åˆ†äº«é€£çµ
            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(message)}`;
            document.getElementById('lineShareBtn').href = lineUrl;
        }

        // æ¸…ç©ºæ‰€æœ‰é¸æ“‡
        function clearAll() {
            selectedTime = '';
            selectedParticipants = [];
            
            // æ¸…é™¤æ™‚é–“æŒ‰éˆ•é¸æ“‡
            document.querySelectorAll('.time-buttons .btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // æ¸…é™¤åƒèˆ‡è€…æŒ‰éˆ•é¸æ“‡
            document.querySelectorAll('.participant-buttons .btn').forEach(btn => {
                btn.classList.remove('selected');
                // æ¢å¾©åŸå§‹åç¨±
                const originalName = btn.textContent.split(' âœ…')[0];
                btn.textContent = originalName;
            });
            
            // æ¸…ç©ºè¨Šæ¯
            document.getElementById('outputText').textContent = 'è«‹é¸æ“‡æ™‚é–“å’Œåƒèˆ‡è€…ä¾†ç”Ÿæˆè¨Šæ¯';
            document.getElementById('lineShareBtn').href = '#';
            
            showStatus('å·²æ¸…ç©ºæ‰€æœ‰é¸æ“‡', 'success');
        }

        // è¤‡è£½æ–‡å­—
        async function copyText() {
            const text = document.getElementById('outputText').textContent;
            
            if (text === 'è«‹é¸æ“‡æ™‚é–“å’Œåƒèˆ‡è€…ä¾†ç”Ÿæˆè¨Šæ¯') {
                showStatus('è«‹å…ˆé¸æ“‡åƒèˆ‡è€…', 'error');
                return;
            }

            try {
                await navigator.clipboard.writeText(text);
                showStatus('æ–‡å­—å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿', 'success');
                
                // è¨˜éŒ„æ•¸æ“šåˆ°é›²ç«¯
                await recordCourtData();
                
            } catch (err) {
                console.error('è¤‡è£½å¤±æ•—:', err);
                showStatus('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–æ–‡å­—', 'error');
            }
        }

        // è¨˜éŒ„æ•¸æ“šåˆ°é›²ç«¯
        async function recordCourtData() {
            if (selectedParticipants.length === 0) return;

            showStatus('æ­£åœ¨åŒæ­¥æ•¸æ“š...', 'loading');

            try {
                // é©—è­‰æ•¸æ“šæ ¼å¼
                if (!validateParticipants(selectedParticipants)) {
                    throw new Error('æ•¸æ“šæ ¼å¼ä¸æ­£ç¢º');
                }

                const today = new Date().toISOString().split('T')[0];
                const data = {
                    date: today,
                    participants: selectedParticipants.map(p => p.name),
                    timestamp: new Date().toISOString()
                };

                // å¯«å…¥ç•¶æ—¥è¨˜éŒ„
                await database.ref(`court_reminders/${today}`).set(data);

                // æ›´æ–°çµ±è¨ˆ
                const statsRef = database.ref('statistics');
                const snapshot = await statsRef.once('value');
                const stats = snapshot.val() || {};

                selectedParticipants.forEach(participant => {
                    const key = participant.name.replace(/\s+/g, '_');
                    stats[key] = {
                        name: participant.name,
                        count: (stats[key] ? stats[key].count : 0) + 1
                    };
                });

                await statsRef.set(stats);

                showStatus('æ•¸æ“šå·²åŒæ­¥åˆ°é›²ç«¯', 'success');

            } catch (error) {
                console.error('è¨˜éŒ„æ•¸æ“šå¤±æ•—:', error);
                showStatus('é›²ç«¯åŒæ­¥å¤±æ•—ï¼Œæ•¸æ“šå·²å„²å­˜åˆ°æœ¬åœ°', 'error');
                
                // å‚™ç”¨ï¼šå„²å­˜åˆ°æœ¬åœ°
                saveToLocalStorage();
            }
        }

        // é©—è­‰åƒèˆ‡è€…æ•¸æ“š
        function validateParticipants(participants) {
            if (!Array.isArray(participants)) return false;
            
            for (let participant of participants) {
                if (!participant.name || typeof participant.name !== 'string') return false;
                if (participant.name.length > 50) return false; // é™åˆ¶åç¨±é•·åº¦
                if (!/^[a-zA-Z0-9\u4e00-\u9fa5\s]+$/.test(participant.name)) return false; // åªå…è¨±ä¸­è‹±æ–‡æ•¸å­—ç©ºæ ¼
            }
            
            return participants.length <= 25; // é™åˆ¶åƒèˆ‡è€…æ•¸é‡
        }

        // å‚™ç”¨ï¼šå„²å­˜åˆ°æœ¬åœ°
        function saveToLocalStorage() {
            const today = new Date().toISOString().split('T')[0];
            const data = {
                date: today,
                participants: selectedParticipants.map(p => p.name),
                timestamp: new Date().toISOString()
            };

            localStorage.setItem(`court_reminder_${today}`, JSON.stringify(data));

            // æ›´æ–°çµ±è¨ˆ
            selectedParticipants.forEach(participant => {
                const key = `stats_${participant.name.replace(/\s+/g, '_')}`;
                const currentCount = parseInt(localStorage.getItem(key) || '0');
                localStorage.setItem(key, (currentCount + 1).toString());
            });
        }

        // è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š
        async function loadDashboardData() {
            try {
                const statsRef = database.ref('statistics');
                const snapshot = await statsRef.once('value');
                const stats = snapshot.val() || {};

                const statsArray = Object.values(stats).sort((a, b) => b.count - a.count);

                // ç²å–æœ€å¾Œæ›´æ–°æ™‚é–“
                const remindersRef = database.ref('court_reminders');
                const remindersSnapshot = await remindersRef.orderByChild('timestamp').limitToLast(1).once('value');
                const lastReminder = remindersSnapshot.val();
                const lastUpdate = lastReminder ? Object.values(lastReminder)[0].date : 'N/A';

                const data = {
                    totalNotifications: statsArray.reduce((sum, s) => sum + s.count, 0),
                    activeParticipants: statsArray.length,
                    lastUpdate: lastUpdate,
                    statistics: statsArray
                };

                updateDashboard(data);

            } catch (error) {
                console.error('è¼‰å…¥å„€è¡¨æ¿æ•¸æ“šå¤±æ•—:', error);
                // å‚™ç”¨ï¼šå¾æœ¬åœ°è¼‰å…¥
                loadLocalDashboardData();
            }
        }

        // æ›´æ–°å„€è¡¨æ¿é¡¯ç¤º
        function updateDashboard(data) {
            // æ›´æ–°ç¸½çµ±è¨ˆ
            document.getElementById('totalNotifications').textContent = data.totalNotifications;
            document.getElementById('activeParticipants').textContent = data.activeParticipants;
            document.getElementById('lastUpdate').textContent = data.lastUpdate;

            // æ›´æ–°æ’è¡Œæ¦œ
            const rankingList = document.getElementById('rankingList');
            if (data.statistics.length === 0) {
                rankingList.innerHTML = '<p>å°šç„¡æ•¸æ“š</p>';
            } else {
                rankingList.innerHTML = data.statistics.slice(0, 5).map((stat, index) => `
                    <div class="ranking-item">
                        <div>
                            <span class="ranking-number">#${index + 1}</span>
                            ${stat.name}
                        </div>
                        <div>${stat.count} æ¬¡</div>
                    </div>
                `).join('');
            }

            // æ›´æ–°é »ç‡åœ–è¡¨
            updateFrequencyChart(data.statistics);
        }

        // æ›´æ–°é »ç‡åœ–è¡¨
        function updateFrequencyChart(statistics) {
            const chartContainer = document.getElementById('frequencyChart');
            
            if (statistics.length === 0) {
                chartContainer.innerHTML = '<p>å°šç„¡æ•¸æ“š</p>';
                return;
            }

            const maxCount = Math.max(...statistics.map(s => s.count));
            
            // æ‰€æœ‰åƒèˆ‡è€…åˆ—è¡¨
            const allParticipants = [
                'ä½³ä½‘ Arvin', 'éŸ‹ä¼¶ Lynn', 'å®¶æ¦® Barry', 'æ¯…åº­ Eden', 'å† å‹³ Andersen',
                'åœ‹å® Luke', 'åº­å®‡ Ben', 'é¡¯å¾· Jerry', 'å˜‰è ChiaWen', 'å¯Œç¿” Oscar',
                'å† ç¿” Damien', 'æ–¹ç…’ Tony', 'æ°å‡± Adam', 'æ”¿å®‡ Dennis', 'å®‡æº¢ Eugene',
                'éˆè²¿ CM', 'å°ç™½ Chuck', 'æ¥Šå‡± Zack', 'ä½³å® Ian', 'å¾·æ…¶ Lantis',
                'å˜‰èƒ¤ John', 'å®—ç¿°'
            ];

            chartContainer.innerHTML = allParticipants.map(name => {
                const stat = statistics.find(s => s.name === name);
                const count = stat ? stat.count : 0;
                const percentage = maxCount > 0 ? (count / maxCount) * 100 : 0;

                return `
                    <div class="chart-item">
                        <div class="chart-label">${name}</div>
                        <div class="chart-bar" style="width: ${percentage}%"></div>
                        <div class="chart-value">${count}</div>
                    </div>
                `;
            }).join('');
        }

        // å‚™ç”¨ï¼šå¾æœ¬åœ°è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š
        function loadLocalDashboardData() {
            // å¾ localStorage è¼‰å…¥æ•¸æ“š
            const statistics = [];
            const allParticipants = [
                'ä½³ä½‘ Arvin', 'éŸ‹ä¼¶ Lynn', 'å®¶æ¦® Barry', 'æ¯…åº­ Eden', 'å† å‹³ Andersen',
                'åœ‹å® Luke', 'åº­å®‡ Ben', 'é¡¯å¾· Jerry', 'å˜‰è ChiaWen', 'å¯Œç¿” Oscar',
                'å† ç¿” Damien', 'æ–¹ç…’ Tony', 'æ°å‡± Adam', 'æ”¿å®‡ Dennis', 'å®‡æº¢ Eugene',
                'éˆè²¿ CM', 'å°ç™½ Chuck', 'æ¥Šå‡± Zack', 'ä½³å® Ian', 'å¾·æ…¶ Lantis',
                'å˜‰èƒ¤ John', 'å®—ç¿°'
            ];

            allParticipants.forEach(name => {
                const key = `stats_${name.replace(/\s+/g, '_')}`;
                const count = parseInt(localStorage.getItem(key) || '0');
                if (count > 0) {
                    statistics.push({ name, count });
                }
            });

            statistics.sort((a, b) => b.count - a.count);

            const data = {
                totalNotifications: statistics.reduce((sum, s) => sum + s.count, 0),
                activeParticipants: statistics.length,
                lastUpdate: 'æœ¬åœ°æ•¸æ“š',
                statistics: statistics
            };

            updateDashboard(data);
        }

        // æ¸…é™¤æ‰€æœ‰æ•¸æ“š
        async function clearAllData() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰çµ±è¨ˆè³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                return;
            }

            try {
                // æ¸…é™¤é›²ç«¯æ•¸æ“š
                await database.ref('court_reminders').remove();
                await database.ref('statistics').remove();
                showStatus('é›²ç«¯æ•¸æ“šå·²æ¸…é™¤', 'success');
            } catch (error) {
                console.error('æ¸…é™¤é›²ç«¯æ•¸æ“šå¤±æ•—:', error);
                showStatus('æ¸…é™¤é›²ç«¯æ•¸æ“šå¤±æ•—ï¼Œä½†æœ¬åœ°æ•¸æ“šå·²æ¸…é™¤', 'error');
            }

            // æ¸…é™¤æœ¬åœ°æ•¸æ“š
            const keys = Object.keys(localStorage);
            keys.forEach(key => {
                if (key.startsWith('stats_') || key.startsWith('court_reminder_')) {
                    localStorage.removeItem(key);
                }
            });

            showStatus('æœ¬åœ°æ•¸æ“šå·²æ¸…é™¤', 'success');
            loadDashboardData();
        }

        // é¡¯ç¤ºç‹€æ…‹è¨Šæ¯
        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // é é¢è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // è¼‰å…¥å„€è¡¨æ¿æ•¸æ“š
            loadDashboardData();
        });
    </script>
</body>
</html>

