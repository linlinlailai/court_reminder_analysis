<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êê∂Â†¥ÈÄöÁü•Áî¢ÁîüÂô®</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .firebase-config {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .firebase-config h3 {
            margin-top: 0;
            color: #495057;
        }

        .firebase-config input {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-size: 14px;
        }

        .firebase-config button {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .firebase-config button:hover {
            background: #218838;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            display: none;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .tab.active {
            background: white;
            color: #007bff;
            border-bottom: 3px solid #007bff;
        }

        .tab:hover {
            background: #dee2e6;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .time-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .time-btn {
            padding: 12px 20px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .time-btn.selected {
            background: #007bff;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,123,255,0.3);
        }

        .participants {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .participant-btn {
            padding: 15px;
            border: 2px solid #6c757d;
            background: white;
            color: #6c757d;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-weight: 500;
        }

        .participant-btn.selected {
            border-color: #28a745;
            background: #28a745;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .copy-btn {
            background: #007bff;
            color: white;
        }

        .copy-btn:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .clear-btn {
            background: #6c757d;
            color: white;
        }

        .clear-btn:hover {
            background: #545b62;
            transform: translateY(-2px);
        }

        .line-btn {
            background: #28a745;
            color: white;
        }

        .line-btn:hover {
            background: #1e7e34;
            transform: translateY(-2px);
        }

        .output {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            min-height: 150px;
            line-height: 1.6;
        }

        .dashboard {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .leaderboard {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .leaderboard h3 {
            margin-top: 0;
            color: #495057;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .rank {
            font-weight: bold;
            color: #007bff;
            margin-right: 10px;
        }

        .frequency-chart {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .frequency-chart h3 {
            margin-top: 0;
            color: #495057;
        }

        .chart-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .chart-label {
            width: 120px;
            font-size: 14px;
            color: #495057;
        }

        .chart-bar {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            margin: 0 10px;
            position: relative;
            overflow: hidden;
        }

        .chart-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #0056b3);
            border-radius: 10px;
            transition: width 0.5s ease;
        }

        .chart-value {
            width: 30px;
            text-align: right;
            font-weight: bold;
            color: #495057;
        }

        .clear-data-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 20px;
        }

        .clear-data-btn:hover {
            background: #c82333;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .tab-content {
                padding: 20px;
            }

            .time-buttons {
                justify-content: center;
            }

            .participants {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }

            .actions {
                flex-direction: column;
            }

            .action-btn {
                min-width: auto;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè∏ Êê∂Â†¥ÈÄöÁü•Áî¢ÁîüÂô®</h1>
        </div>

        <div class="firebase-config" id="firebaseConfig">
            <h3>üîß Firebase Ë®≠ÂÆö</h3>
            <input type="text" id="apiKey" placeholder="API Key">
            <input type="text" id="authDomain" placeholder="Auth Domain (‰æãÂ¶Ç: your-project.firebaseapp.com)">
            <input type="text" id="databaseURL" placeholder="Database URL (‰æãÂ¶Ç: https://your-project-default-rtdb.asia-southeast1.firebasedatabase.app/)">
            <input type="text" id="projectId" placeholder="Project ID">
            <button onclick="connectFirebase()">ÈÄ£Êé• Firebase</button>
            <div id="statusMessage" class="status-message"></div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('generator')">ÈÄöÁü•Áî¢ÁîüÂô®</button>
            <button class="tab" onclick="showTab('dashboard')">ÊâìÁêÉÈ†ªÁéáÂÑÄË°®Êùø</button>
        </div>

        <div id="generator" class="tab-content active">
            <h2>‚è∞ ÈÅ∏ÊìáÊôÇÈñì</h2>
            <div class="time-buttons">
                <button class="time-btn" onclick="selectTime('18:00')">18:00</button>
                <button class="time-btn" onclick="selectTime('18:30')">18:30</button>
                <button class="time-btn" onclick="selectTime('19:00')">19:00</button>
                <button class="time-btn" onclick="selectTime('19:30')">19:30</button>
                <button class="time-btn" onclick="selectTime('20:00')">20:00</button>
            </div>

            <h2>üë• ÈÅ∏ÊìáÂèÉËàáËÄÖ</h2>
            <div class="participants">
                <button class="participant-btn" onclick="toggleParticipant('‰Ω≥‰Ωë Arvin')">‰Ω≥‰Ωë Arvin</button>
                <button class="participant-btn" onclick="toggleParticipant('Èüã‰º∂ Lynn')">Èüã‰º∂ Lynn</button>
                <button class="participant-btn" onclick="toggleParticipant('ÂÆ∂Ê¶Æ Barry')">ÂÆ∂Ê¶Æ Barry</button>
                <button class="participant-btn" onclick="toggleParticipant('ÊØÖÂ∫≠ Eden')">ÊØÖÂ∫≠ Eden</button>
                <button class="participant-btn" onclick="toggleParticipant('ÂÜ†Âã≥ Andersen')">ÂÜ†Âã≥ Andersen</button>
                <button class="participant-btn" onclick="toggleParticipant('ÂúãÂÆè Luke')">ÂúãÂÆè Luke</button>
                <button class="participant-btn" onclick="toggleParticipant('Â∫≠ÂÆá Ben')">Â∫≠ÂÆá Ben</button>
                <button class="participant-btn" onclick="toggleParticipant('È°ØÂæ∑ Jerry')">È°ØÂæ∑ Jerry</button>
                <button class="participant-btn" onclick="toggleParticipant('ÂòâËÅû ChiaWen')">ÂòâËÅû ChiaWen</button>
                <button class="participant-btn" onclick="toggleParticipant('ÂØåÁøî Oscar')">ÂØåÁøî Oscar</button>
                <button class="participant-btn" onclick="toggleParticipant('ÂÜ†Áøî Damien')">ÂÜ†Áøî Damien</button>
                <button class="participant-btn" onclick="toggleParticipant('ÊñπÁÖí Tony')">ÊñπÁÖí Tony</button>
                <button class="participant-btn" onclick="toggleParticipant('Êù∞Âá± Adam')">Êù∞Âá± Adam</button>
                <button class="participant-btn" onclick="toggleParticipant('ÊîøÂÆá Dennis')">ÊîøÂÆá Dennis</button>
                <button class="participant-btn" onclick="toggleParticipant('ÂÆáÊ∫¢ Eugene')">ÂÆáÊ∫¢ Eugene</button>
                <button class="participant-btn" onclick="toggleParticipant('ÈàûË≤ø CM')">ÈàûË≤ø CM</button>
                <button class="participant-btn" onclick="toggleParticipant('Â∞èÁôΩ Chuck')">Â∞èÁôΩ Chuck</button>
                <button class="participant-btn" onclick="toggleParticipant('Ê•äÂá± Zack')">Ê•äÂá± Zack</button>
                <button class="participant-btn" onclick="toggleParticipant('‰Ω≥ÂÆè Ian')">‰Ω≥ÂÆè Ian</button>
                <button class="participant-btn" onclick="toggleParticipant('Âæ∑ÊÖ∂ Lantis')">Âæ∑ÊÖ∂ Lantis</button>
                <button class="participant-btn" onclick="toggleParticipant('ÂòâËÉ§ John')">ÂòâËÉ§ John</button>
                <button class="participant-btn" onclick="toggleParticipant('ÂÆóÁø∞')">ÂÆóÁø∞</button>
            </div>

            <div class="actions">
                <button class="action-btn copy-btn" onclick="copyText()">üìã Ë§áË£ΩÊñáÂ≠ó</button>
                <button class="action-btn clear-btn" onclick="clearAll()">üßπ Ê∏ÖÁ©∫ÂÖ®ÈÉ®</button>
                <button class="action-btn line-btn" onclick="shareToLine()">üí¨ ÂàÜ‰∫´Âà∞ LINE</button>
            </div>

            <div class="output" id="output">Ë´ãÈÅ∏ÊìáÊôÇÈñìÂíåÂèÉËàáËÄÖ...</div>
        </div>

        <div id="dashboard" class="tab-content">
            <div class="dashboard">
                <h2>üìä ÊâìÁêÉÈ†ªÁéáÁµ±Ë®à</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalNotifications">0</div>
                        <div class="stat-label">Á∏ΩÈÄöÁü•Ê¨°Êï∏</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="activeParticipants">0</div>
                        <div class="stat-label">Ê¥ªË∫çÂèÉËàáËÄÖ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="lastUpdate">ÂæûÊú™</div>
                        <div class="stat-label">ÊúÄÂæåÊõ¥Êñ∞</div>
                    </div>
                </div>

                <div class="leaderboard">
                    <h3>üèÜ ÂèÉËàáÊéíË°åÊ¶ú (Ââç5Âêç)</h3>
                    <div id="leaderboardList">
                        <div class="leaderboard-item">
                            <span>Êö´ÁÑ°Êï∏Êìö</span>
                        </div>
                    </div>
                </div>

                <div class="frequency-chart">
                    <h3>üìà ÂÄã‰∫∫ÊâìÁêÉÈ†ªÁéá</h3>
                    <div id="frequencyChart">
                        <div class="chart-item">
                            <span>Êö´ÁÑ°Êï∏Êìö</span>
                        </div>
                    </div>
                </div>

                <button class="clear-data-btn" onclick="clearAllData()">Ê∏ÖÈô§ÊâÄÊúâÁµ±Ë®àË≥áÊñô</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        let selectedTime = '';
        let selectedParticipants = [];
        let isFirebaseConnected = false;
        let database = null;

        const participants = [
            '‰Ω≥‰Ωë Arvin', 'Èüã‰º∂ Lynn', 'ÂÆ∂Ê¶Æ Barry', 'ÊØÖÂ∫≠ Eden', 'ÂÜ†Âã≥ Andersen',
            'ÂúãÂÆè Luke', 'Â∫≠ÂÆá Ben', 'È°ØÂæ∑ Jerry', 'ÂòâËÅû ChiaWen', 'ÂØåÁøî Oscar',
            'ÂÜ†Áøî Damien', 'ÊñπÁÖí Tony', 'Êù∞Âá± Adam', 'ÊîøÂÆá Dennis', 'ÂÆáÊ∫¢ Eugene',
            'ÈàûË≤ø CM', 'Â∞èÁôΩ Chuck', 'Ê•äÂá± Zack', '‰Ω≥ÂÆè Ian', 'Âæ∑ÊÖ∂ Lantis',
            'ÂòâËÉ§ John', 'ÂÆóÁø∞'
        ];

        function connectFirebase() {
            const apiKey = document.getElementById('apiKey').value;
            const authDomain = document.getElementById('authDomain').value;
            const databaseURL = document.getElementById('databaseURL').value;
            const projectId = document.getElementById('projectId').value;

            if (!apiKey || !authDomain || !databaseURL || !projectId) {
                showStatus('Ë´ãÂ°´ÂØ´ÊâÄÊúâ Firebase Ë®≠ÂÆöÊ¨Ñ‰Ωç', 'error');
                return;
            }

            try {
                const firebaseConfig = {
                    apiKey: apiKey,
                    authDomain: authDomain,
                    databaseURL: databaseURL,
                    projectId: projectId
                };

                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                isFirebaseConnected = true;

                // ÂÑ≤Â≠òË®≠ÂÆöÂà∞ localStorage
                localStorage.setItem('firebaseConfig', JSON.stringify(firebaseConfig));

                showStatus('Firebase ÈÄ£Êé•ÊàêÂäüÔºÅÈõ≤Á´ØÂêåÊ≠•Â∑≤ÂïüÁî®„ÄÇ', 'success');
                
                // Èö±ËóèË®≠ÂÆöÂçÄÂüü
                setTimeout(() => {
                    document.getElementById('firebaseConfig').style.display = 'none';
                }, 2000);

                // ËºâÂÖ•ÂÑÄË°®ÊùøÊï∏Êìö
                loadDashboardData();
            } catch (error) {
                console.error('Firebase ÈÄ£Êé•Â§±Êïó:', error);
                showStatus('Firebase ÈÄ£Êé•Â§±ÊïóÔºö' + error.message, 'error');
            }
        }

        function showStatus(message, type) {
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent = message;
            statusElement.className = `status-message status-${type}`;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }

        // Ê™¢Êü•ÊòØÂê¶ÊúâÂÑ≤Â≠òÁöÑ Firebase Ë®≠ÂÆö
        function checkSavedConfig() {
            const savedConfig = localStorage.getItem('firebaseConfig');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('apiKey').value = config.apiKey || '';
                    document.getElementById('authDomain').value = config.authDomain || '';
                    document.getElementById('databaseURL').value = config.databaseURL || '';
                    document.getElementById('projectId').value = config.projectId || '';
                    
                    // Ëá™ÂãïÈÄ£Êé•
                    connectFirebase();
                } catch (error) {
                    console.error('ËºâÂÖ•ÂÑ≤Â≠òÁöÑË®≠ÂÆöÂ§±Êïó:', error);
                }
            }
        }

        function showTab(tabName) {
            // Èö±ËóèÊâÄÊúâÂàÜÈ†ÅÂÖßÂÆπ
            const contents = document.querySelectorAll('.tab-content');
            contents.forEach(content => content.classList.remove('active'));

            // ÁßªÈô§ÊâÄÊúâÂàÜÈ†ÅÊåâÈàïÁöÑ active È°ûÂà•
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // È°ØÁ§∫ÈÅ∏‰∏≠ÁöÑÂàÜÈ†ÅÂÖßÂÆπ
            document.getElementById(tabName).classList.add('active');

            // Ê∑ªÂä† active È°ûÂà•Âà∞Â∞çÊáâÁöÑÂàÜÈ†ÅÊåâÈàï
            event.target.classList.add('active');

            // Â¶ÇÊûúÂàáÊèõÂà∞ÂÑÄË°®ÊùøÔºåËºâÂÖ•Êï∏Êìö
            if (tabName === 'dashboard') {
                loadDashboardData();
            }
        }

        function selectTime(time) {
            selectedTime = time;
            
            // ÁßªÈô§ÊâÄÊúâÊôÇÈñìÊåâÈàïÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
            const timeButtons = document.querySelectorAll('.time-btn');
            timeButtons.forEach(btn => btn.classList.remove('selected'));
            
            // Ê∑ªÂä†ÈÅ∏‰∏≠ÁãÄÊÖãÂà∞Áï∂ÂâçÊåâÈàï
            event.target.classList.add('selected');
            
            updateParticipantButtons();
            updateOutput();
        }

        function toggleParticipant(name) {
            if (!selectedTime) {
                alert('Ë´ãÂÖàÈÅ∏ÊìáÊôÇÈñìÔºÅ');
                return;
            }

            const index = selectedParticipants.findIndex(p => p.name === name);
            
            if (index > -1) {
                // ÁßªÈô§ÂèÉËàáËÄÖ
                selectedParticipants.splice(index, 1);
                event.target.classList.remove('selected');
                event.target.textContent = name;
            } else {
                // Ê∑ªÂä†ÂèÉËàáËÄÖ
                selectedParticipants.push({ name: name, time: selectedTime });
                event.target.classList.add('selected');
                event.target.textContent = `${name} ‚úÖ (${selectedTime})`;
            }
            
            updateOutput();
        }

        function updateParticipantButtons() {
            const participantButtons = document.querySelectorAll('.participant-btn');
            participantButtons.forEach(btn => {
                const name = btn.textContent.replace(' ‚úÖ (18:00)', '').replace(' ‚úÖ (18:30)', '').replace(' ‚úÖ (19:00)', '').replace(' ‚úÖ (19:30)', '').replace(' ‚úÖ (20:00)', '');
                const participant = selectedParticipants.find(p => p.name === name);
                
                if (participant) {
                    btn.classList.add('selected');
                    btn.textContent = `${name} ‚úÖ (${participant.time})`;
                } else {
                    btn.classList.remove('selected');
                    btn.textContent = name;
                }
            });
        }

        function updateOutput() {
            const output = document.getElementById('output');
            
            if (selectedParticipants.length === 0) {
                output.textContent = 'Ë´ãÈÅ∏ÊìáÊôÇÈñìÂíåÂèÉËàáËÄÖ...';
                return;
            }

            // ÊåâÊôÇÈñìÂàÜÁµÑ
            const timeGroups = {};
            selectedParticipants.forEach(participant => {
                if (!timeGroups[participant.time]) {
                    timeGroups[participant.time] = [];
                }
                timeGroups[participant.time].push(participant.name);
            });

            // ÁîüÊàêËº∏Âá∫ÊñáÂ≠ó
            const today = new Date();
            const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
            
            let outputText = `È∫ªÁÖ©${dateStr}Êôö‰∏ä‰ª£Ë®ÇÂ†¥Âú∞\n03-560-1068\nÂ†¥Âú∞È†êÁ¥ÑÈ†ÜÂ∫èABCD\n`;
            
            Object.keys(timeGroups).sort().forEach(time => {
                const names = timeGroups[time];
                outputText += `${time}\n`;
                outputText += `CK17583${names.map(name => name.split(' ')[0]).join('')}\n`;
            });

            output.textContent = outputText;
        }

        function copyText() {
            const output = document.getElementById('output');
            const text = output.textContent;
            
            if (text === 'Ë´ãÈÅ∏ÊìáÊôÇÈñìÂíåÂèÉËàáËÄÖ...') {
                alert('Ë´ãÂÖàÈÅ∏ÊìáÊôÇÈñìÂíåÂèÉËàáËÄÖÔºÅ');
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                // ÈÅ∏‰∏≠ÊñáÂ≠ó‰ª•Êèê‰æõË¶ñË¶∫ÂèçÈ•ã
                const range = document.createRange();
                range.selectNodeContents(output);
                const selection = window.getSelection();
                selection.removeAllRanges();
                selection.addRange(range);

                // Ë®òÈåÑÊï∏Êìö
                recordData();
            }).catch(err => {
                console.error('Ë§áË£ΩÂ§±Êïó:', err);
                alert('Ë§áË£ΩÂ§±ÊïóÔºåË´ãÊâãÂãïË§áË£ΩÊñáÂ≠ó');
            });
        }

        function shareToLine() {
            const output = document.getElementById('output');
            const text = output.textContent;
            
            if (text === 'Ë´ãÈÅ∏ÊìáÊôÇÈñìÂíåÂèÉËàáËÄÖ...') {
                alert('Ë´ãÂÖàÈÅ∏ÊìáÊôÇÈñìÂíåÂèÉËàáËÄÖÔºÅ');
                return;
            }

            const lineUrl = `https://line.me/R/msg/text/?${encodeURIComponent(text)}`;
            window.open(lineUrl, '_blank');

            // Ë®òÈåÑÊï∏Êìö
            recordData();
        }

        function clearAll() {
            selectedTime = '';
            selectedParticipants = [];
            
            // Ê∏ÖÈô§ÊâÄÊúâÊåâÈàïÁöÑÈÅ∏‰∏≠ÁãÄÊÖã
            const timeButtons = document.querySelectorAll('.time-btn');
            timeButtons.forEach(btn => btn.classList.remove('selected'));
            
            const participantButtons = document.querySelectorAll('.participant-btn');
            participantButtons.forEach((btn, index) => {
                btn.classList.remove('selected');
                btn.textContent = participants[index];
            });
            
            updateOutput();
        }

        function recordData() {
            if (selectedParticipants.length === 0) return;

            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD Ê†ºÂºè
            const timestamp = new Date().toISOString();

            const recordData = {
                date: today,
                participants: selectedParticipants.map(p => p.name),
                timestamp: timestamp
            };

            if (isFirebaseConnected && database) {
                // ÂÑ≤Â≠òÂà∞ Firebase
                saveToFirebase(recordData);
            } else {
                // ÂÑ≤Â≠òÂà∞ localStorage ‰ΩúÁÇ∫ÂÇôÁî®
                saveToLocalStorage(recordData);
            }
        }

        function saveToFirebase(recordData) {
            try {
                // ÂÑ≤Â≠òÁï∂Êó•Ë®òÈåÑÔºàÊúÉË¶ÜËìãÂêå‰∏ÄÂ§©ÁöÑËàäË®òÈåÑÔºâ
                database.ref(`court_reminders/${recordData.date}`).set(recordData);

                // Êõ¥Êñ∞ÂÄã‰∫∫Áµ±Ë®à
                recordData.participants.forEach(participant => {
                    const participantRef = database.ref(`statistics/${participant.replace(/\s+/g, '_')}`);
                    participantRef.transaction((currentData) => {
                        if (currentData === null) {
                            return {
                                name: participant,
                                count: 1
                            };
                        } else {
                            return {
                                name: participant,
                                count: currentData.count + 1
                            };
                        }
                    });
                });

                console.log('Êï∏ÊìöÂ∑≤ÂÑ≤Â≠òÂà∞ Firebase');
            } catch (error) {
                console.error('Firebase ÂÑ≤Â≠òÂ§±Êïó:', error);
                // Â¶ÇÊûú Firebase Â§±ÊïóÔºå‰ΩøÁî® localStorage ÂÇôÁî®
                saveToLocalStorage(recordData);
            }
        }

        function saveToLocalStorage(recordData) {
            try {
                // Áç≤ÂèñÁèæÊúâÊï∏Êìö
                const existingData = JSON.parse(localStorage.getItem('courtReminderData') || '{}');
                
                // ÂÑ≤Â≠òÁï∂Êó•Ë®òÈåÑ
                existingData[recordData.date] = recordData;
                
                // Êõ¥Êñ∞ÂÄã‰∫∫Áµ±Ë®à
                const statistics = JSON.parse(localStorage.getItem('courtReminderStats') || '{}');
                recordData.participants.forEach(participant => {
                    if (!statistics[participant]) {
                        statistics[participant] = { name: participant, count: 0 };
                    }
                    statistics[participant].count++;
                });
                
                localStorage.setItem('courtReminderData', JSON.stringify(existingData));
                localStorage.setItem('courtReminderStats', JSON.stringify(statistics));
                
                console.log('Êï∏ÊìöÂ∑≤ÂÑ≤Â≠òÂà∞Êú¨Âú∞ÂÑ≤Â≠ò');
            } catch (error) {
                console.error('Êú¨Âú∞ÂÑ≤Â≠òÂ§±Êïó:', error);
            }
        }

        function loadDashboardData() {
            if (isFirebaseConnected && database) {
                loadFromFirebase();
            } else {
                loadFromLocalStorage();
            }
        }

        function loadFromFirebase() {
            try {
                // ËºâÂÖ•Áµ±Ë®àÊï∏Êìö
                database.ref('statistics').once('value', (snapshot) => {
                    const statistics = snapshot.val() || {};
                    updateDashboard(statistics);
                });

                // ËºâÂÖ•Ë®òÈåÑÊï∏Êìö‰ª•Ë®àÁÆóÁ∏ΩÈÄöÁü•Ê¨°Êï∏ÂíåÊúÄÂæåÊõ¥Êñ∞ÊôÇÈñì
                database.ref('court_reminders').once('value', (snapshot) => {
                    const records = snapshot.val() || {};
                    updateGeneralStats(records);
                });
            } catch (error) {
                console.error('Firebase ËºâÂÖ•Â§±Êïó:', error);
                loadFromLocalStorage();
            }
        }

        function loadFromLocalStorage() {
            try {
                const statistics = JSON.parse(localStorage.getItem('courtReminderStats') || '{}');
                const records = JSON.parse(localStorage.getItem('courtReminderData') || '{}');
                
                updateDashboard(statistics);
                updateGeneralStats(records);
            } catch (error) {
                console.error('Êú¨Âú∞ÂÑ≤Â≠òËºâÂÖ•Â§±Êïó:', error);
            }
        }

        function updateDashboard(statistics) {
            // ËΩâÊèõÁÇ∫Èô£Âàó‰∏¶ÊéíÂ∫è
            const statsArray = Object.values(statistics).sort((a, b) => b.count - a.count);
            
            // Êõ¥Êñ∞Ê¥ªË∫çÂèÉËàáËÄÖÊï∏Èáè
            document.getElementById('activeParticipants').textContent = statsArray.length;
            
            // Êõ¥Êñ∞ÊéíË°åÊ¶ú
            updateLeaderboard(statsArray);
            
            // Êõ¥Êñ∞È†ªÁéáÂúñË°®
            updateFrequencyChart(statsArray);
        }

        function updateGeneralStats(records) {
            const recordsArray = Object.values(records);
            
            // Êõ¥Êñ∞Á∏ΩÈÄöÁü•Ê¨°Êï∏
            document.getElementById('totalNotifications').textContent = recordsArray.length;
            
            // Êõ¥Êñ∞ÊúÄÂæåÊõ¥Êñ∞ÊôÇÈñì
            if (recordsArray.length > 0) {
                const lastRecord = recordsArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];
                const lastUpdate = new Date(lastRecord.timestamp);
                const timeStr = lastUpdate.toLocaleString('zh-TW');
                document.getElementById('lastUpdate').textContent = timeStr;
            }
        }

        function updateLeaderboard(statsArray) {
            const leaderboardList = document.getElementById('leaderboardList');
            
            if (statsArray.length === 0) {
                leaderboardList.innerHTML = '<div class="leaderboard-item"><span>Êö´ÁÑ°Êï∏Êìö</span></div>';
                return;
            }
            
            const top5 = statsArray.slice(0, 5);
            leaderboardList.innerHTML = top5.map((stat, index) => `
                <div class="leaderboard-item">
                    <span><span class="rank">#${index + 1}</span>${stat.name}</span>
                    <span>${stat.count} Ê¨°</span>
                </div>
            `).join('');
        }

        function updateFrequencyChart(statsArray) {
            const frequencyChart = document.getElementById('frequencyChart');
            
            if (statsArray.length === 0) {
                frequencyChart.innerHTML = '<div class="chart-item"><span>Êö´ÁÑ°Êï∏Êìö</span></div>';
                return;
            }
            
            const maxCount = Math.max(...statsArray.map(s => s.count));
            
            // È°ØÁ§∫ÊâÄÊúâÂèÉËàáËÄÖÔºåÂåÖÊã¨Ê¨°Êï∏ÁÇ∫ 0 ÁöÑ
            const allParticipants = participants.map(name => {
                const stat = statsArray.find(s => s.name === name);
                return {
                    name: name,
                    count: stat ? stat.count : 0
                };
            });
            
            frequencyChart.innerHTML = allParticipants.map(stat => {
                const percentage = maxCount > 0 ? (stat.count / maxCount) * 100 : 0;
                return `
                    <div class="chart-item">
                        <div class="chart-label">${stat.name}</div>
                        <div class="chart-bar">
                            <div class="chart-fill" style="width: ${percentage}%"></div>
                        </div>
                        <div class="chart-value">${stat.count}</div>
                    </div>
                `;
            }).join('');
        }

        function clearAllData() {
            if (confirm('Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâÁµ±Ë®àË≥áÊñôÂóéÔºüÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ')) {
                if (isFirebaseConnected && database) {
                    // Ê∏ÖÈô§ Firebase Êï∏Êìö
                    database.ref('statistics').remove();
                    database.ref('court_reminders').remove();
                }
                
                // Ê∏ÖÈô§Êú¨Âú∞ÂÑ≤Â≠ò
                localStorage.removeItem('courtReminderData');
                localStorage.removeItem('courtReminderStats');
                
                // ÈáçÊñ∞ËºâÂÖ•ÂÑÄË°®Êùø
                loadDashboardData();
                
                alert('ÊâÄÊúâÁµ±Ë®àË≥áÊñôÂ∑≤Ê∏ÖÈô§');
            }
        }

        // È†ÅÈù¢ËºâÂÖ•ÊôÇÊ™¢Êü•ÂÑ≤Â≠òÁöÑË®≠ÂÆö
        window.addEventListener('load', () => {
            checkSavedConfig();
        });
    </script>
</body>
</html>

